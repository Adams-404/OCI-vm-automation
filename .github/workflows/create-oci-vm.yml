name: Evergreeners OCI VM Creation

on:
  workflow_dispatch:  # You can manually trigger this from GitHub Actions UI

jobs:
  create-vm:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install OCI CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip python3-pip
          pip3 install oci

      - name: Configure OCI CLI
        run: |
          mkdir -p $HOME/.oci
          echo "[DEFAULT]" > $HOME/.oci/config
          echo "user=$OCI_USER_OCID" >> $HOME/.oci/config
          echo "fingerprint=$OCI_FINGERPRINT" >> $HOME/.oci/config
          echo "key_file=$HOME/.oci/oci_api_key.pem" >> $HOME/.oci/config
          echo "tenancy=$OCI_TENANCY_OCID" >> $HOME/.oci/config
          echo "region=$OCI_REGION" >> $HOME/.oci/config
          echo "$OCI_KEY_CONTENT" | base64 --decode > $HOME/.oci/oci_api_key.pem
          chmod 600 $HOME/.oci/oci_api_key.pem

      - name: Retry VM Creation Until Success
        run: |
          echo "Starting VM creation loop..."
          while true; do
            set -e
            CREATE_OUTPUT=$(oci compute instance launch \
              --compartment-id $OCI_COMPARTMENT_OCID \
              --availability-domain "$OCI_AD" \
              --shape "VM.Standard.A1.Flex" \
              --display-name "evergreeners-backend" \
              --image-id $OCI_UBUNTU_IMAGE_ID \
              --subnet-id $OCI_SUBNET_ID \
              --ssh-authorized-keys-file <(echo "$SSH_PUBLIC_KEY") \
              --wait-for-state RUNNING || true)

            echo "$CREATE_OUTPUT"

            # Check if the VM was successfully created
            if echo "$CREATE_OUTPUT" | grep -q '"lifecycle-state": "RUNNING"'; then
              echo "VM successfully created!"
              break
            else
              echo "VM not created yet. Retrying in 2m30s..."
              sleep 150
            fi
          done
